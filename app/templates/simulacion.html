{% extends "base.html" %}

{% block title %}Simulación de Habitaciones{% endblock %}

{% block extra_css %}
<style>
    .room {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #f9f9f9;
    }
    
    .bed {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: white;
        position: relative;
    }
    
    .bed-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .indicator-off {
        background-color: #ccc;
    }
    
    .indicator-pending {
        background-color: #ffc107;
        animation: blink 1s infinite;
    }
    
    .indicator-attending {
        background-color: #28a745;
    }
    
    @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Simulación de Habitaciones</h1>
    
    {% if is_assistant %}
    <div class="alert alert-info">
        Estás registrado como asistente: <strong>{{ assistant.name }}</strong>
    </div>
    {% else %}
    <div class="alert alert-warning">
        Estás en modo paciente. Para ver opciones de asistente, <a href="{{ url_for('auth.login') }}">inicia sesión como asistente</a> y <a href="{{ url_for('main.enroll') }}">enrola tu dispositivo</a>.
    </div>
    {% endif %}
    
    <div class="row">
        {% for room_num in range(101, 106) %}
        <div class="col-md-6 col-lg-4">
            <div class="room">
                <h3>Habitación {{ room_num }}</h3>
                
                {% for bed_letter in ['A', 'B'] %}
                <div class="bed">
                    <div class="bed-header">
                        <h4>Cama {{ bed_letter }}</h4>
                        {% set room_bed_key = room_num|string + '_' + bed_letter %}
                        {% if room_bed_key in call_map %}
                            {% if call_map[room_bed_key].status == 'pending' %}
                                <div class="indicator indicator-pending" title="Llamada pendiente"></div>
                            {% elif call_map[room_bed_key].status == 'attending' %}
                                <div class="indicator indicator-attending" title="Asistencia en curso"></div>
                            {% endif %}
                        {% else %}
                            <div class="indicator indicator-off" title="Sin llamadas"></div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        {% if not is_assistant %}
                            <button class="btn btn-primary call-button" 
                                    data-room="{{ room_num }}" 
                                    data-bed="{{ bed_letter }}">
                                Llamar Asistencia
                            </button>
                        {% else %}
                            {% set room_bed_key = room_num|string + '_' + bed_letter %}
                            {% if room_bed_key in call_map %}
                                {% if call_map[room_bed_key].status == 'pending' %}
                                    <button class="btn btn-warning attend-button" 
                                            data-call-id="{{ call_map[room_bed_key].id }}">
                                        Atender Llamada
                                    </button>
                                {% elif call_map[room_bed_key].status == 'attending' %}
                                    <button class="btn btn-success presence-button" 
                                            data-room="{{ room_num }}" 
                                            data-bed="{{ bed_letter }}">
                                        Confirmar Asistencia
                                    </button>
                                {% else %}
                                    <button class="btn btn-secondary" disabled>Sin Llamadas</button>
                                {% endif %}
                            {% else %}
                                <button class="btn btn-secondary" disabled>Sin Llamadas</button>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Manejar botones de llamada (para pacientes)
        document.querySelectorAll('.call-button').forEach(button => {
            button.addEventListener('click', function() {
                const room = this.dataset.room;
                const bed = this.dataset.bed;
                
                // Llamar a la API para registrar la llamada
                fetch(`/llamada/${room}/${bed}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Llamada registrada correctamente');
                            // Recargar la página para mostrar el estado actualizado
                            location.reload();
                        } else {
                            alert('Error al registrar la llamada');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al comunicarse con el servidor');
                    });
            });
        });
        
        // Manejar botones de atención (para asistentes)
        document.querySelectorAll('.attend-button').forEach(button => {
            button.addEventListener('click', function() {
                const callId = this.dataset.callId;
                
                // Llamar a la API para atender la llamada
                fetch(`/atender/${callId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Llamada atendida correctamente');
                            // Recargar la página para mostrar el estado actualizado
                            location.reload();
                        } else {
                            alert(`Error: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al comunicarse con el servidor');
                    });
            });
        });
        
        // Manejar botones de presencia (para asistentes)
        document.querySelectorAll('.presence-button').forEach(button => {
            button.addEventListener('click', function() {
                const room = this.dataset.room;
                const bed = this.dataset.bed;
                
                // Llamar a la API para registrar la presencia
                fetch(`/presencia/${room}/${bed}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Presencia registrada correctamente');
                            // Recargar la página para mostrar el estado actualizado
                            location.reload();
                        } else {
                            alert(`Error: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al comunicarse con el servidor');
                    });
            });
        });
    });
</script>
{% endblock %} 